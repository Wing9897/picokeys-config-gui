# Pico-HSM 完整教學指南

本文件說明 Pico-HSM 硬體安全模組的核心概念與操作方式。

---

## 目錄

1. [什麼是 HSM？](#什麼是-hsm)
2. [PIN 與 SO-PIN](#pin-與-so-pin)
3. [DKEK 備份機制](#dkek-備份機制)
4. [金鑰管理](#金鑰管理)
5. [憑證管理](#憑證管理)
6. [組態設定](#組態設定)
7. [常見操作流程](#常見操作流程)
8. [安全建議](#安全建議)

---

## 什麼是 HSM？

**HSM（Hardware Security Module，硬體安全模組）** 是一種專門用於保護加密金鑰的實體裝置。

### 主要特點

| 特點 | 說明 |
|------|------|
| 金鑰永不離開裝置 | 私鑰在 HSM 內部生成，無法被匯出 |
| 防篡改設計 | 物理攻擊會觸發金鑰銷毀機制 |
| 獨立運算 | 加密/簽章運算在 HSM 內部完成 |
| 存取控制 | 需要 PIN 才能使用金鑰 |

### Pico-HSM 是什麼？

Pico-HSM 是基於 Raspberry Pi Pico 的開源 HSM 實作，相容於 SmartCard-HSM 標準，透過 PC/SC 智慧卡介面與電腦通訊。

---

## PIN 與 SO-PIN

HSM 使用兩層密碼保護機制：

### PIN（Personal Identification Number）

**用途：** 一般使用者的日常操作密碼

| 項目 | 說明 |
|------|------|
| 長度 | 6-16 個字元 |
| 用途 | 解鎖裝置、存取金鑰、執行簽章 |
| 錯誤限制 | 連續錯誤 **3 次**後鎖定 |
| 解鎖方式 | 使用 SO-PIN 解鎖 |

**使用場景：**
- 列出金鑰清單
- 使用金鑰進行簽章
- 匯入/匯出憑證
- 日常加密操作

### SO-PIN（Security Officer PIN）

**用途：** 管理員密碼，擁有最高權限

| 項目 | 說明 |
|------|------|
| 格式 | **16 個十六進位字元**（0-9, a-f） |
| 範例 | `0123456789abcdef` |
| 用途 | 初始化裝置、解鎖 PIN、重設裝置 |
| 錯誤限制 | 連續錯誤 **15 次**後裝置永久鎖定 |

**使用場景：**
- 初始化新裝置
- 解鎖被鎖定的 PIN
- 變更 SO-PIN 本身
- 執行裝置重設

### 類比說明

```
┌─────────────────────────────────────────────┐
│                  HSM 裝置                    │
├─────────────────────────────────────────────┤
│                                             │
│   PIN ──────► 員工門禁卡                     │
│               • 日常進出使用                  │
│               • 錯 3 次被鎖                  │
│                                             │
│   SO-PIN ───► 管理員萬能鑰匙                  │
│               • 可以解鎖任何門                │
│               • 遺失後無法補發                │
│                                             │
└─────────────────────────────────────────────┘
```

---

## DKEK 備份機制

### 什麼是 DKEK？

**DKEK（Device Key Encryption Key）** 是用於加密備份金鑰的主金鑰。

### 為什麼需要 DKEK？

HSM 的設計原則是「私鑰永不離開裝置」，但這帶來一個問題：如果裝置損壞，金鑰就永久遺失了。

DKEK 提供了一個安全的備份方案：
1. 金鑰匯出時，使用 DKEK 加密
2. 加密後的金鑰可以安全儲存
3. 匯入時，使用相同的 DKEK 解密

### DKEK 份額（Shares）

為了增加安全性，DKEK 可以拆分成多個「份額」：

```
DKEK 份額機制示意圖：

     原始 DKEK
         │
    ┌────┼────┐
    ▼    ▼    ▼
  份額1 份額2 份額3
    │    │    │
    └────┼────┘
         ▼
   需要全部份額
   才能還原 DKEK
```

**設定範例：**
- `DKEK 份數 = 0`：不使用 DKEK，無法備份金鑰
- `DKEK 份數 = 1`：單一份額，一個檔案即可備份
- `DKEK 份數 = 3`：需要 3 個份額才能還原（可分給不同人保管）

### DKEK 操作流程

#### 1. 初始化時設定份數

```
初始化裝置
    │
    ├── PIN: 設定使用者密碼
    ├── SO-PIN: 設定管理員密碼
    └── DKEK 份數: 設定備份份額數量
```

#### 2. 建立 DKEK 份額

```
建立份額
    │
    ├── 輸入保護密碼
    └── 下載 .bin 檔案（妥善保管！）
```

#### 3. 匯入 DKEK 份額（還原時）

```
匯入份額
    │
    ├── 選擇 .bin 檔案
    ├── 輸入保護密碼
    └── 重複直到所有份額匯入完成
```

#### 4. 金鑰備份/還原

```
備份金鑰                    還原金鑰
    │                          │
    ├── 輸入 PIN               ├── 輸入 PIN
    ├── 選擇金鑰 ID            ├── 選擇金鑰 ID
    └── 下載加密備份            └── 上傳加密備份
```

---

## 金鑰管理

### 金鑰類型

Pico-HSM 支援三種金鑰類型：

#### 1. RSA 金鑰

| 項目 | 說明 |
|------|------|
| 用途 | 數位簽章、加密 |
| 長度選項 | 1024 / 2048 / 3072 / 4096 位元 |
| 特點 | 相容性最好，但速度較慢 |
| 建議 | 一般用途選 2048，高安全需求選 4096 |

#### 2. EC 金鑰（橢圓曲線）

| 項目 | 說明 |
|------|------|
| 用途 | 數位簽章、金鑰交換 |
| 曲線選項 | secp256r1 / secp384r1 / secp521r1 / brainpoolP256r1 |
| 特點 | 相同安全等級下，金鑰更短、速度更快 |
| 建議 | 新專案優先選用 secp256r1 |

#### 3. AES 金鑰

| 項目 | 說明 |
|------|------|
| 用途 | 對稱加密 |
| 長度選項 | 128 / 192 / 256 位元 |
| 特點 | 加解密速度快 |
| 建議 | 一般選 256 位元 |

### 金鑰屬性

每個金鑰都有以下屬性：

| 屬性 | 說明 |
|------|------|
| ID | 0-255 的數字，用於識別金鑰 |
| Label | 人類可讀的標籤名稱 |
| Key Ref | 內部參考編號 |
| Usage | 用途（簽章、加密、金鑰交換等） |

### 金鑰生命週期

```
┌──────────┐    ┌──────────┐    ┌──────────┐
│  生成    │───►│  使用    │───►│  刪除    │
└──────────┘    └──────────┘    └──────────┘
     │              │
     │              ▼
     │         ┌──────────┐
     │         │  備份    │（需要 DKEK）
     │         └──────────┘
     │              │
     ▼              ▼
┌──────────────────────────────────┐
│           安全儲存               │
└──────────────────────────────────┘
```

---

## 憑證管理

### 什麼是憑證？

**X.509 憑證**是一種數位文件，用於證明公鑰的擁有者身份。

### 憑證結構

```
┌─────────────────────────────────┐
│           X.509 憑證            │
├─────────────────────────────────┤
│ Subject（主體）                  │
│   └── 憑證擁有者的身份資訊        │
│                                 │
│ Issuer（發行者）                 │
│   └── 簽發此憑證的 CA            │
│                                 │
│ Valid From / To（有效期間）       │
│   └── 憑證的有效時間範圍          │
│                                 │
│ Public Key（公鑰）               │
│   └── 對應的公開金鑰             │
│                                 │
│ Signature（簽章）                │
│   └── CA 的數位簽章              │
└─────────────────────────────────┘
```

### 憑證與金鑰的關係

```
HSM 內部：
┌─────────────────────────────────┐
│  金鑰 ID: 1                      │
│  ├── 私鑰（永不離開 HSM）         │
│  └── 公鑰                        │
└─────────────────────────────────┘
           │
           ▼ 公鑰匯出
┌─────────────────────────────────┐
│  憑證簽發請求（CSR）              │
│  └── 包含公鑰 + 身份資訊          │
└─────────────────────────────────┘
           │
           ▼ CA 簽發
┌─────────────────────────────────┐
│  X.509 憑證                      │
│  └── 匯入回 HSM，關聯到金鑰 ID: 1 │
└─────────────────────────────────┘
```

### 憑證操作

| 操作 | 說明 |
|------|------|
| 匯入 | 將 CA 簽發的憑證匯入 HSM |
| 匯出 | 將憑證匯出為 DER 格式檔案 |
| 關聯 | 憑證透過 Key ID 與金鑰關聯 |

---

## 組態設定

### Press to Confirm（按鈕確認）

| 項目 | 說明 |
|------|------|
| 功能 | 執行敏感操作時需要按下實體按鈕確認 |
| 用途 | 防止惡意軟體在背景偷偷使用金鑰 |
| 建議 | 高安全需求環境建議啟用 |

**運作方式：**
```
應用程式請求簽章
        │
        ▼
   HSM 等待確認
        │
        ▼
  使用者按下按鈕 ──► 執行簽章
        │
   （超時未按）
        │
        ▼
     操作取消
```

### Key Usage Counter（金鑰使用計數器）

| 項目 | 說明 |
|------|------|
| 功能 | 記錄每個金鑰被使用的次數 |
| 用途 | 稽核追蹤、異常偵測 |
| 建議 | 企業環境建議啟用 |

### RTC Sync（即時時鐘同步）

| 項目 | 說明 |
|------|------|
| 功能 | 將電腦時間同步到 HSM 內部時鐘 |
| 用途 | 確保時間戳記正確 |
| 建議 | 定期執行同步 |

### Secure Lock（安全鎖）

| 項目 | 說明 |
|------|------|
| 功能 | 鎖定裝置的某些管理功能 |
| 啟用 | 防止未授權的組態變更 |
| 停用 | 允許變更組態設定 |

### LED 設定

| 項目 | 說明 |
|------|------|
| GPIO | LED 連接的 GPIO 腳位編號 |
| Brightness | 亮度（0-255） |
| Dimmable | 是否支援調光 |
| Color | LED 顏色（如 #FF0000） |

---

## 常見操作流程

### 流程一：全新裝置設定

```
步驟 1: 初始化裝置
┌─────────────────────────────────┐
│ • 設定 PIN（日常使用）           │
│ • 設定 SO-PIN（管理員）          │
│ • 設定 DKEK 份數（建議 1-3）     │
└─────────────────────────────────┘
              │
              ▼
步驟 2: 建立 DKEK 份額
┌─────────────────────────────────┐
│ • 設定保護密碼                   │
│ • 下載並安全保管 .bin 檔案       │
│ • 重複直到所有份額建立完成        │
└─────────────────────────────────┘
              │
              ▼
步驟 3: 生成金鑰
┌─────────────────────────────────┐
│ • 選擇金鑰類型（RSA/EC/AES）     │
│ • 設定金鑰 ID 和標籤             │
│ • 等待金鑰生成完成               │
└─────────────────────────────────┘
              │
              ▼
步驟 4: 備份金鑰（建議）
┌─────────────────────────────────┐
│ • 匯出金鑰的加密備份             │
│ • 安全保管備份檔案               │
└─────────────────────────────────┘
```

### 流程二：PIN 被鎖定

```
PIN 連續錯誤 3 次
        │
        ▼
   PIN 被鎖定
        │
        ▼
前往「PIN 管理」頁面
        │
        ▼
使用「解鎖 PIN」功能
        │
        ├── 輸入 SO-PIN
        └── 設定新 PIN
              │
              ▼
        PIN 解鎖成功
```

### 流程三：裝置損壞後還原

```
新裝置初始化
（使用相同的 DKEK 份數）
        │
        ▼
匯入所有 DKEK 份額
        │
        ▼
還原金鑰備份
        │
        ▼
匯入憑證
        │
        ▼
    還原完成
```

---

## 安全建議

### PIN 管理

- 使用強密碼，避免簡單數字如 `123456`
- 不要將 PIN 寫在裝置上或貼在電腦旁
- 定期更換 PIN

### SO-PIN 管理

- **務必妥善保管**，遺失後無法恢復
- 建議寫在紙上，存放於保險箱或安全處
- 不要只存在電腦檔案中（可能被駭客竊取）
- 考慮分開保管（如：前 8 碼和後 8 碼分開存放）

### DKEK 份額管理

- 每個份額使用不同的保護密碼
- 份額檔案和密碼分開保管
- 多份額時，分給不同的信任人員保管
- 定期驗證份額檔案是否可讀取

### 金鑰備份

- 初始化後立即建立 DKEK 份額
- 生成金鑰後立即備份
- 備份檔案存放於離線儲存裝置
- 定期測試還原流程

### 實體安全

- 不使用時將 HSM 存放於安全處
- 避免在公共場所使用
- 啟用 Press to Confirm 功能

---

## 術語對照表

| 英文 | 中文 | 說明 |
|------|------|------|
| HSM | 硬體安全模組 | Hardware Security Module |
| PIN | 個人識別碼 | Personal Identification Number |
| SO-PIN | 安全管理員 PIN | Security Officer PIN |
| DKEK | 裝置金鑰加密金鑰 | Device Key Encryption Key |
| RSA | RSA 演算法 | 非對稱加密演算法 |
| EC | 橢圓曲線 | Elliptic Curve |
| AES | 進階加密標準 | Advanced Encryption Standard |
| X.509 | X.509 憑證 | 數位憑證標準格式 |
| CA | 憑證授權中心 | Certificate Authority |
| CSR | 憑證簽發請求 | Certificate Signing Request |
| PC/SC | 智慧卡介面 | Personal Computer/Smart Card |

---

## 常見問題

### Q: 忘記 PIN 怎麼辦？

使用 SO-PIN 在「PIN 管理」頁面解鎖並重設 PIN。

### Q: 忘記 SO-PIN 怎麼辦？

**無法恢復**。必須重新初始化裝置，所有金鑰將遺失。這就是為什麼要妥善保管 SO-PIN 和金鑰備份。

### Q: DKEK 份額檔案遺失怎麼辦？

如果遺失任何一個份額，將無法還原金鑰備份。建議：
1. 每個份額製作多個副本
2. 存放於不同的安全位置

### Q: 可以在多台電腦上使用同一個 HSM 嗎？

可以。HSM 是獨立裝置，插入任何支援 PC/SC 的電腦都可以使用。

### Q: 金鑰可以複製到另一個 HSM 嗎？

可以，但需要：
1. 兩個 HSM 使用相同的 DKEK
2. 從來源 HSM 匯出加密備份
3. 在目標 HSM 匯入備份

---

*本文件適用於 Pico Config GUI v0.1.0*
